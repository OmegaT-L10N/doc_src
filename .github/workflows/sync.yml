name: Sync English manual from upstream

on:
  schedule:
    # Every Saturday at 03:03 UTC
    - cron: '3 3 * * 6'
  workflow_dispatch:
    inputs:
      reason:
        description: Optional reason for manual run
        required: false

permissions:
  contents: write
  issues: write

concurrency:
  group: sync-i18n-en
  cancel-in-progress: false

env:
  UPSTREAM_REPO: omegat-org/omegat
  DEFAULT_BRANCH: master
  MAINTAINANCE_BRANCH: releases/6.0
  MAINTAINANCE_TREE_DIR: omegat-releases-6.0
  BRANCH_TARGET: docs-6.0

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v5
        with:
          ref: master
          fetch-depth: 0

      - name: Set up Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "l10n-github-actions@noreply.omegat.org"

      - name: Fetch from upstream repository
        run: |
          git clone --depth=1 https://github.com/${{ env.UPSTREAM_REPO }}.git _upstream
          curl -L -o _upstream/branch.tar.gz https://github.com/${{ env.UPSTREAM_REPO }}/archive/refs/heads/${{ env.MAINTAINANCE_BRANCH }}.tar.gz
          cd _upstream
          tar xf branch.tar.gz

      - name: Replace local English with upstream version
        run: |
          set -e
          rm -rf en || true
          rm -rf greeting || true
          rm -rf tips || true
          rm -rf ${{ env.BRANCH_TARGET }} || true
          mkdir -p en
          mkdir -p greeting
          mkdir -p tips
          mkdir -p ${{ env.BRANCH_TARGET }}
          # Copy to "en" for backward compatibility
          cp -r _upstream/src_docs/manual/en/* ./en/
          cp -r _upstream/src_docs/greeting/en/* ./greeting/
          cp -r _upstream/src_docs/tips/en/* ./tips/
          cp -r _upstream/${{ env.MAINTAINANCE_TREE_DIR}/doc_src/en/* ./${{ env.BRANCH_TARGET }}/

      - name: Stage changes
        run: |
          git add en greeting tips ${{ env.BRANCH_TARGET }}

      - name: Check for differences
        id: diff
        run: |
          if git diff --staged --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit changes
        if: steps.diff.outputs.changed == 'true'
        run: |
          ts="$(date -u +'%Y-%m-%d')"
          git commit -m "Sync manual(en) from upstream ${UPSTREAM_REPO} on ${ts}"

      - name: Push to master
        if: steps.diff.outputs.changed == 'true'
        run: |
          git push origin HEAD:master
